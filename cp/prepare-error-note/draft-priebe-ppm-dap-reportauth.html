<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>Report authentication for PPM DAP</title>
<meta content="Christian Priebe" name="author">
<meta content="Linmao Song" name="author">
<meta content="
       This document describes an upload extension to the Distributed
Aggregation Protocol for Privacy Preserving Measurement
 . The extension contains a Privacy
Pass token as defined in
 , which allows
Aggregators to verify a DAP report is from a client which has been
authenticated and optionally rate-limited, without learning the client's
identity, to protect against Sybil attacks. 
    " name="description">
<meta content="xml2rfc 3.17.4" name="generator">
<meta content="authentication" name="keyword">
<meta content="rate limiting" name="keyword">
<meta content="privacy preserving measurement" name="keyword">
<meta content="distributed aggregation protocol" name="keyword">
<meta content="draft-priebe-ppm-dap-reportauth-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.17.4
    Python 3.11.4
    ConfigArgParse 1.5.3
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.2
    platformdirs 3.8.0
    pycountry 22.3.5
    PyYAML 6.0
    requests 2.31.0
    setuptools 67.7.2
    six 1.16.0
    wcwidth 0.2.6
-->
<link href="draft-priebe-ppm-dap-reportauth.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 0.75em 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre {
    page-break-inside: avoid;
  }
  figure {
    overflow: scroll;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  h2+*, h3+*, h4+*, h5+*, h6+* {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Give the table caption label the same styling as the figcaption */

@media print {
  .toplink {
    display: none;
  }

  /* avoid overwriting the top border line with the ToC header */
  #toc {
    padding-top: 1px;
  }

  /* Avoid page breaks inside dl and author address entries */
  dd {
    page-break-before: avoid;
  }
  .vcard {
    page-break-inside: avoid;
  }

}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">Report authentication for PPM DAP</td>
<td class="right">July 2023</td>
</tr></thead>
<tfoot><tr>
<td class="left">Priebe &amp; Song</td>
<td class="center">Expires 8 January 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Privacy Preserving Measurement</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-priebe-ppm-dap-reportauth-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2023-07-07" class="published">7 July 2023</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-01-08">8 January 2024</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">C. Priebe</div>
<div class="org">Apple Inc.</div>
</div>
<div class="author">
      <div class="author-name">L. Song</div>
<div class="org">Apple Inc.</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">Report authentication for PPM DAP</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes an upload extension to the Distributed
Aggregation Protocol for Privacy Preserving Measurement
<span>[<a href="#DAP" class="cite xref">DAP</a>]</span>. The extension contains a Privacy
Pass token as defined in
<span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span>, which allows
Aggregators to verify a DAP report is from a client which has been
authenticated and optionally rate-limited, without learning the client's
identity, to protect against Sybil attacks.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<section class="note rfcEditorRemove" id="section-note.1">
      <h2 id="name-about-this-document">
<a href="#name-about-this-document" class="section-name selfRef">About This Document</a>
      </h2>
<p id="section-note.1-1">This note is to be removed before publishing as an RFC.<a href="#section-note.1-1" class="pilcrow">¶</a></p>
<p id="section-note.1-2">
        The latest revision of this draft can be found at <span><a href="https://cpriebe.github.io/draft-priebe-ppm-dap-reportauth/draft-priebe-ppm-dap-reportauth.html">https://cpriebe.github.io/draft-priebe-ppm-dap-reportauth/draft-priebe-ppm-dap-reportauth.html</a></span>.
        Status information for this document may be found at <span><a href="https://datatracker.ietf.org/doc/draft-priebe-ppm-dap-reportauth/">https://datatracker.ietf.org/doc/draft-priebe-ppm-dap-reportauth/</a></span>.<a href="#section-note.1-2" class="pilcrow">¶</a></p>
<p id="section-note.1-3">
        Discussion of this document takes place on the
        Privacy Preserving Measurement Working Group mailing list (<span><a href="mailto:ppm@ietf.org">mailto:ppm@ietf.org</a></span>),
        which is archived at <span><a href="https://mailarchive.ietf.org/arch/browse/ppm/">https://mailarchive.ietf.org/arch/browse/ppm/</a></span>.
        Subscribe at <span><a href="https://www.ietf.org/mailman/listinfo/ppm/">https://www.ietf.org/mailman/listinfo/ppm/</a></span>.<a href="#section-note.1-3" class="pilcrow">¶</a></p>
<p id="section-note.1-4">Source for this draft and an issue tracker can be found at
        <span><a href="https://github.com/cpriebe/draft-priebe-ppm-dap-reportauth">https://github.com/cpriebe/draft-priebe-ppm-dap-reportauth</a></span>.<a href="#section-note.1-4" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 8 January 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2023 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-conventions-and-definitions" class="internal xref">Conventions and Definitions</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-the-reportauth-extension" class="internal xref">The ReportAuth extension</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-overview" class="internal xref">Overview</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-extension-definition" class="internal xref">Extension definition</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-client-behavior" class="internal xref">Client behavior</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-challenge-synthesis" class="internal xref">Challenge synthesis</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-token-acquisition" class="internal xref">Token acquisition</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3">
                <p id="section-toc.1-1.4.2.3.1"><a href="#section-4.3" class="auto internal xref">4.3</a>.  <a href="#name-report-creation" class="internal xref">Report creation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3.2.1">
                    <p id="section-toc.1-1.4.2.3.2.1.1"><a href="#section-4.3.1" class="auto internal xref">4.3.1</a>.  <a href="#name-constructing-the-reportauth" class="internal xref">Constructing the ReportAuth extension</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.3.2.2">
                    <p id="section-toc.1-1.4.2.3.2.2.1"><a href="#section-4.3.2" class="auto internal xref">4.3.2</a>.  <a href="#name-setting-the-report-id" class="internal xref">Setting the report ID</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-aggregator-behavior" class="internal xref">Aggregator behavior</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-security-considerations" class="internal xref">Security Considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1" class="auto internal xref">6.1</a>.  <a href="#name-threat-model" class="internal xref">Threat model</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2" class="auto internal xref">6.2</a>.  <a href="#name-timing-and-frequency-of-tok" class="internal xref">Timing and frequency of token issuance requests</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3" class="auto internal xref">6.3</a>.  <a href="#name-challenge-synthesis-2" class="internal xref">Challenge synthesis</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.4">
                <p id="section-toc.1-1.6.2.4.1"><a href="#section-6.4" class="auto internal xref">6.4</a>.  <a href="#name-token-key-and-issuer-origin" class="internal xref">Token Key and Issuer Origin Secret rotation with rate-limited tokens</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5">
                <p id="section-toc.1-1.6.2.5.1"><a href="#section-6.5" class="auto internal xref">6.5</a>.  <a href="#name-compromised-parties-and-col" class="internal xref">Compromised parties and collusion</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5.2.1">
                    <p id="section-toc.1-1.6.2.5.2.1.1"><a href="#section-6.5.1" class="auto internal xref">6.5.1</a>.  <a href="#name-malicious-client" class="internal xref">Malicious Client</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5.2.2">
                    <p id="section-toc.1-1.6.2.5.2.2.1"><a href="#section-6.5.2" class="auto internal xref">6.5.2</a>.  <a href="#name-malicious-attester" class="internal xref">Malicious Attester</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5.2.3">
                    <p id="section-toc.1-1.6.2.5.2.3.1"><a href="#section-6.5.3" class="auto internal xref">6.5.3</a>.  <a href="#name-malicious-issuer" class="internal xref">Malicious Issuer</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5.2.4">
                    <p id="section-toc.1-1.6.2.5.2.4.1"><a href="#section-6.5.4" class="auto internal xref">6.5.4</a>.  <a href="#name-malicious-aggregator" class="internal xref">Malicious Aggregator</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5.2.5">
                    <p id="section-toc.1-1.6.2.5.2.5.1"><a href="#section-6.5.5" class="auto internal xref">6.5.5</a>.  <a href="#name-collusion-between-attester-" class="internal xref">Collusion between Attester and Leader</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6.2.5.2.6">
                    <p id="section-toc.1-1.6.2.5.2.6.1"><a href="#section-6.5.6" class="auto internal xref">6.5.6</a>.  <a href="#name-collusion-between-issuer-an" class="internal xref">Collusion between Issuer and Helper</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-iana-considerations" class="internal xref">IANA Considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-normative-references" class="internal xref">Normative References</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-contributors" class="internal xref">Contributors</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#appendix-B" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The Distributed Aggregation Protocol for Privacy Preserving Measurement
<span>[<a href="#DAP" class="cite xref">DAP</a>]</span> defines a multi-party distributed aggregation protocol that
allows measuring sensitive user data on a collective level, without
revealing any individual participant's identity or data.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">The anonymous nature of the data upload comes with the risk of Sybil
Attacks. A malicious party may generate a large number of reports, then
upload them to the aggregators to skew aggregation results in order to
reveal information about honest measurements (privacy violation), or to
influence results to their benefit ("stats poisoning"). Client
authentication and rate limiting can be used to throttle such attacks.
However, authentication and effective rate limiting requires associating
an upload with a client identity, and thus defeats the purpose of
<span>[<a href="#DAP" class="cite xref">DAP</a>]</span>.<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">Privacy Pass tokens as defined in <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span> offer a framework to solve
this dilemma. In this protocol, a client can go through a token issuance
process to generate unlinkable one-time use authentication tokens. By
presenting the token to a service provider (i.e. the Origin, as defined
in <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span>), a client can prove to have been authenticated by an
Attester that the service provider trusts, without revealing its
identity to the latter.<a href="#section-1-3" class="pilcrow">¶</a></p>
<p id="section-1-4">This document provides the specification for a <span>[<a href="#DAP" class="cite xref">DAP</a>]</span> upload report
extension that leverages Privacy Pass tokens to mitigate the Sybil
attack risk in <span>[<a href="#DAP" class="cite xref">DAP</a>]</span> uploads. For this, Clients request a fixed
number of tokens for each Aggregator it sends report shares to within
each token issuance window. Token issuance follows the process outlined
in <span>[<a href="#PPISSUANCE" class="cite xref">PPISSUANCE</a>]</span>. As part of this
process, the Client is authenticated by the Attester. When a Client
contributes to a measurement task, it adds a token for each Aggregator
to the corresponding encrypted input share within the report.<a href="#section-1-4" class="pilcrow">¶</a></p>
<p id="section-1-5">Rate-Limited Privacy Pass tokens
<span>[<a href="#RATE-LIMITED" class="cite xref">RATE-LIMITED</a>]</span>
provide further protection against Sybil attacks by introducing an
issuance protocol in which token requests are rate-limited by the
Attester according to the policy defined by the Issuer which issues
tokens as defined in <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span>. While it is <span class="bcp14">RECOMMENDED</span> to use
rate-limited tokens to prevent authenticated Clients from launching
Sybil attacks, the DAP extension described in this document is
compatible with any type of Privacy Pass tokens. Non-rate-limited tokens
can be sufficient if authenticated clients are assumed to not launch
Sybil attacks.<a href="#section-1-5" class="pilcrow">¶</a></p>
<p id="section-1-6">Aggregators that opt-in to support this extension fulfill the role of
Origins as defined in <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span>. When an Aggregator receives an input
share, it validates the token by verifying the token signature using the
public Token Key from the Issuer as outlined in
<span>[<a href="#PPAUTHSCHEME" class="cite xref">PPAUTHSCHEME</a>]</span>. It also verifies that
the token nonce has not been seen for the current task to prevent double
spending. Upon successful validation which proves to the Aggregator that
the Client has been authenticated and optionally rate-limited, the
Aggregator can process the report share as outlined in <span>[<a href="#DAP" class="cite xref">DAP</a>]</span>.<a href="#section-1-6" class="pilcrow">¶</a></p>
<p id="section-1-7">This document does not specify the coordination between Aggregators and
Issuers to exchange Token Keys used for validating token signatures or
to configure the Issuer rate-limiting policy. This is assumed to be done
out-of-band.<a href="#section-1-7" class="pilcrow">¶</a></p>
</section>
</div>
<div id="conventions-and-definitions">
<section id="section-2">
      <h2 id="name-conventions-and-definitions">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-conventions-and-definitions" class="section-name selfRef">Conventions and Definitions</a>
      </h2>
<p id="section-2-1">The key words "<span class="bcp14">MUST</span>", "<span class="bcp14">MUST NOT</span>", "<span class="bcp14">REQUIRED</span>", "<span class="bcp14">SHALL</span>", "<span class="bcp14">SHALL NOT</span>", "<span class="bcp14">SHOULD</span>", "<span class="bcp14">SHOULD NOT</span>", "<span class="bcp14">RECOMMENDED</span>", "<span class="bcp14">NOT RECOMMENDED</span>",
"<span class="bcp14">MAY</span>", and "<span class="bcp14">OPTIONAL</span>" in this document are to be interpreted as
described in BCP 14 <span>[<a href="#RFC2119" class="cite xref">RFC2119</a>]</span> <span>[<a href="#RFC8174" class="cite xref">RFC8174</a>]</span> when, and only when, they
appear in all capitals, as shown here.<a href="#section-2-1" class="pilcrow">¶</a></p>
<p id="section-2-2">This document uses the same conventions for error handling as <span>[<a href="#DAP" class="cite xref">DAP</a>]</span>.
In addition, this document extends the core specification by adding the
following error type:<a href="#section-2-2" class="pilcrow">¶</a></p>
<table class="center" id="table-1">
        <caption><a href="#table-1" class="selfRef">Table 1</a></caption>
<thead>
          <tr>
            <th class="text-left" rowspan="1" colspan="1">Type</th>
            <th class="text-left" rowspan="1" colspan="1">Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="text-left" rowspan="1" colspan="1">unauthenticatedReport</td>
            <td class="text-left" rowspan="1" colspan="1">An Aggregator has failed to validate the</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1"> </td>
            <td class="text-left" rowspan="1" colspan="1">input share token or no token was</td>
          </tr>
          <tr>
            <td class="text-left" rowspan="1" colspan="1"> </td>
            <td class="text-left" rowspan="1" colspan="1">provided</td>
          </tr>
        </tbody>
      </table>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-2-4.1">
          <p id="section-2-4.1.1">TODO: This should be a new PrepareError variant, rather than a new
error type URI, see
https://github.com/cpriebe/draft-priebe-ppm-dap-reportauth/issues/8<a href="#section-2-4.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-2-5">The terms used follow the definitions in <span>[<a href="#DAP" class="cite xref">DAP</a>]</span> and <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span>. In
addition, the following terms are used throughout this document:<a href="#section-2-5" class="pilcrow">¶</a></p>
<span class="break"></span><dl class="dlParallel" id="section-2-6">
        <dt id="section-2-6.1">Token:</dt>
        <dd style="margin-left: 1.5em" id="section-2-6.2">
          <p id="section-2-6.2.1">A Privacy Pass Token as defined in <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span> included in upload
report shares to prove that the client has been authenticated and
optionally rate-limited.<a href="#section-2-6.2.1" class="pilcrow">¶</a></p>
</dd>
      <dd class="break"></dd>
</dl>
</section>
</div>
<div id="the-reportauth-extension">
<section id="section-3">
      <h2 id="name-the-reportauth-extension">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-the-reportauth-extension" class="section-name selfRef">The ReportAuth extension</a>
      </h2>
<div id="overview">
<section id="section-3.1">
        <h3 id="name-overview">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-overview" class="section-name selfRef">Overview</a>
        </h3>
<p id="section-3.1-1">The ReportAuth extension encapsulates a token allowing a Client to prove
to Aggregators (Leader and Helpers) that it has been authenticated and
optionally rate-limited without revealing its identity when uploading a
report. The token's lifecycle can be divided into three stages. First,
the client follows the <span>[<a href="#PPISSUANCE" class="cite xref">PPISSUANCE</a>]</span> protocol to obtain a certain
number of Aggregator-specific tokens.  Second, at the time of upload,
the client includes the tokens in ReportAuth extensions within each
Aggregator's input share. Third, the aggregators redeem the tokens as
outlined in <span>[<a href="#PPAUTHSCHEME" class="cite xref">PPAUTHSCHEME</a>]</span>, as part of their aggregation
initialization.  <a href="#fig-interaction-overview" class="auto internal xref">Figure 1</a> shows an overview of the
involved parties and their interactions.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<span id="name-interaction-overview"></span><div id="fig-interaction-overview">
<figure id="figure-1">
          <div class="alignLeft art-text artwork" id="section-3.1-2.1">
<pre>
+---------+   +-----------+    +---------+    +--------+      +--------+
| Client  |   | Attester  |    | Issuer  |    | Leader |      | Helper |
+---------+   +-----------+    +---------+    +--------+      +--------+
     |              |               |             |               |
&lt;per Aggregator&gt;
[Challenge]--------&gt;|               |             |               |
     |     &lt;authenticate Client&gt;    |             |               |
     |              |--[Challenge]-&gt;|             |               |
     |              |&lt;----[Token]---|             |               |
     |    [&lt;enforce rate limit&gt;]    |             |               |
     |&lt;---[Token]---|               |             |               |
     |              |               |             |               |
     |              |               |             |               |
&lt;upon upload&gt;
     |          [payload + tokens      ]          |               |
     |----------[within input share    ]---------&gt;|               |
     |          [Report Auth extensions]          |               |
     |              |               |    &lt;validate Leader token&gt;  |
     |              |               |             | [Helper    ]  |
     |              |               |             |-[share with]-&gt;|
     |              |               |             | [ReportAuth]  |
     |              |               |             | [extension ]  |
     |              |               |             |     &lt;validate token&gt;
</pre>
</div>
<figcaption><a href="#figure-1" class="selfRef">Figure 1</a>:
<a href="#name-interaction-overview" class="selfRef">Interaction overview</a>
          </figcaption></figure>
</div>
</section>
</div>
<div id="extension-definition">
<section id="section-3.2">
        <h3 id="name-extension-definition">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-extension-definition" class="section-name selfRef">Extension definition</a>
        </h3>
<p id="section-3.2-1">The ReportAuth extension contains two elements:<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-3.2-2.1">A Privacy Pass token obtained from an Issuer of the <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span>
architecture. By checking the token's validity, an Aggregator can verify
the uploading client has been authenticated. In case rate-limited token
issuance as described in <span>[<a href="#RATE-LIMITED" class="cite xref">RATE-LIMITED</a>]</span> is used, this also verifies
that the payload is within a rate limit configured in the Issuer.<a href="#section-3.2-2.1" class="pilcrow">¶</a>
</li>
          <li class="normal" id="section-3.2-2.2">The challenge originally used by the client to obtain the token. This
is to allow the Aggregator to reconstruct the context necessary for the
token validation. In the standard <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span> architecture, the challenge
is sent by the Origin, or Aggregator in the case of DAP, to the Client.
In this extension's use case, the challenge is synthesized by the
Client. This removes the requirement for the initial challenge-response
between the Client and the Aggregators.<a href="#section-3.2-2.2" class="pilcrow">¶</a>
</li>
        </ul>
<p id="section-3.2-3">The ReportAuth extension is structured as follows:<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.2-4">
<pre>
struct {
    Token token;
    Challenge challenge;
} ReportAuth;

struct {
    uint16_t token_type;
    uint8_t nonce[32];
    uint8_t challenge_digest[32];
    uint8_t token_key_id[Nid];
    uint8_t authenticator[Nk];
} Token; // as defined in [PPAUTHSCHEME], Section 2.2

struct {
    uint16_t token_type;
    opaque issuer_name&lt;1..2^16-1&gt;;
    opaque redemption_context&lt;0..32&gt;;
    opaque origin_info&lt;0..2^16-1&gt;;
} Challenge; // as defined in [PPAUTHSCHEME], Section 2.1
</pre><a href="#section-3.2-4" class="pilcrow">¶</a>
</div>
<p id="section-3.2-5">The ReportAuth extension's fields' values are as follows:<a href="#section-3.2-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-3.2-6">
<pre>
+----------------+--------------------+-------------------------+------+
| field          | subfield           | Value                   | Note |
+----------------+--------------------+-------------------------+------+
+----------------+--------------------+-------------------------+------+
| Token          | token_type         |                         | [1]  |
+----------------+--------------------+-------------------------+------+
|                | nonce              | See "Setting the        |      |
|                |                    | report ID"              | [1]  |
+----------------+--------------------+-------------------------+------+
|                | challenge_digest   |                         | [1]  |
+----------------+--------------------+-------------------------+------+
|                | token_key_id       |                         | [1]  |
+----------------+--------------------+-------------------------+------+
|                | authenticator      |                         | [1]  |
+----------------+--------------------+-------------------------+------+
| Challenge      |...                 | See "Token Aquisition"  |      |
+----------------+--------------------+-------------------------+------+
</pre><a href="#section-3.2-6" class="pilcrow">¶</a>
</div>
<p id="section-3.2-7">[1] See <span>[<a href="#PPAUTHSCHEME" class="cite xref">PPAUTHSCHEME</a>]</span><a href="#section-3.2-7" class="pilcrow">¶</a></p>
<p id="section-3.2-8">The challenge synthesis, token acquisition, and report creation are
discussed in detail in the following section. The token redemption is
discussed in <a href="#aggregator-behavior" class="auto internal xref">Section 5</a>.<a href="#section-3.2-8" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="client-behavior">
<section id="section-4">
      <h2 id="name-client-behavior">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-client-behavior" class="section-name selfRef">Client behavior</a>
      </h2>
<div id="challenge-synthesis">
<section id="section-4.1">
        <h3 id="name-challenge-synthesis">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-challenge-synthesis" class="section-name selfRef">Challenge synthesis</a>
        </h3>
<p id="section-4.1-1">The generation of the challenge is implementation specific. An
implementation <span class="bcp14">MAY</span> choose to let Aggregators deliver the challenge to
the clients, or it may let the client synthesize the challenge as
follows:<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-4.1-2">
<pre>
+--------------------+--------------------------------------+
| subfield           | Value                                |
+--------------------+--------------------------------------+
| issuer_name        | host name of the Issuer              |
+--------------------+--------------------------------------+
| redemption_context | empty if synthesized by the client,  |
|                    | set by the Aggregator otherwise      |
+--------------------+--------------------------------------+
| origin_info        | host name of the Aggregator          |
+--------------------+--------------------------------------+
</pre><a href="#section-4.1-2" class="pilcrow">¶</a>
</div>
<p id="section-4.1-3">If the client synthesizes the challenge, the redemption_context field
<span class="bcp14">SHOULD</span> be empty.<a href="#section-4.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="token-acquisition">
<section id="section-4.2">
        <h3 id="name-token-acquisition">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-token-acquisition" class="section-name selfRef">Token acquisition</a>
        </h3>
<p id="section-4.2-1">The Client includes the per-Aggregator challenge in token issuance
requests to the <span>[<a href="#PPARCH" class="cite xref">PPARCH</a>]</span> infrastructure. The client <span class="bcp14">MUST</span> obtain a
fixed number of tokens per Aggregator, at a time not associated with the
<span>[<a href="#DAP" class="cite xref">DAP</a>]</span> upload. This can be at random times, or at fixed intervals, as
long as the acquisition time cannot be linked to a specific <span>[<a href="#DAP" class="cite xref">DAP</a>]</span>
upload. This disassociation is important to mitigate timing attacks. See
<a href="#timing-token-issuance" class="auto internal xref">Section 6.2</a> for security considerations on this.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="report-creation">
<section id="section-4.3">
        <h3 id="name-report-creation">
<a href="#section-4.3" class="section-number selfRef">4.3. </a><a href="#name-report-creation" class="section-name selfRef">Report creation</a>
        </h3>
<p id="section-4.3-1"><a href="#fig-reportauth-extension" class="auto internal xref">Figure 2</a> shows an overview of the DAP report
structure. This extension (ReportAuth) is added to the upload extensions
section of each Aggregator's input share in the upload report, as
defined in <span>[<a href="#DAP" class="cite xref">DAP</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04#section-4.3.3" class="relref">Section 4.3.3</a></span>.<a href="#section-4.3-1" class="pilcrow">¶</a></p>
<span id="name-reportauth-extension-within"></span><div id="fig-reportauth-extension">
<figure id="figure-2">
          <div class="alignLeft art-text artwork" id="section-4.3-2.1">
<pre>
+-----------------------------------------------------------+
| Report                                                    |
+--+-----------------------------------------------------+--+
|  | ReportMetadata                                      |  |
|  +--+-----------------------------------------------+--+  |
|  |  | report_id                                     |  |  |
|  |  +-----------------------------------------------+  |  |
|  |  | ...                                           |  |  |
|  +--+-----------------------------------------------+--+  |
|  | PublicShare                                         |  |
|  +-----------------------------------------------------+  |
|  | HpkeCiphertext (encrypted_input_share)              |  |
|  |(per aggregator)                                     |  |
|  +--+-----------------------------------------------+--+  |
|  |  | PlainTextInputShare                           |  |  |
|  +--+--+-----------------------------------------+--+--+  |
|  |  |  | Extensions                              |  |  |  |
|  +--+--+--+-----------------------------------+--+--+--+  |
|  |  |  |  | Extension                         |  |  |  |  |
|  |  +--+--+--+-----------------------------+--+--+--+--+  |
|  |  |  |  |  | extension_type = ReportAuth |  |  |  |  |  |
|  |  +--+--+--+-----------------------------+--+--+--+--+  |
|  |  |  |  |  | ReportAuth extension        |  |  |  |  |  |
|  |  +--+--+--+-----------------------------+--+--+--+--+  |
|  |  |  |  | ...                               |  |  |  |  |
|  |  +--+--+-----------------------------------+--+--+--+  |
|  |  |  | Payload                                 |  |  |  |
+--+--+--+-----------------------------------------+--+--+--+
</pre>
</div>
<figcaption><a href="#figure-2" class="selfRef">Figure 2</a>:
<a href="#name-reportauth-extension-within" class="selfRef">ReportAuth extension within a DAP report</a>
          </figcaption></figure>
</div>
<p id="section-4.3-3">Note that there is currently no defined extension type for this
extension yet, see <a href="#iana-considerations" class="auto internal xref">Section 7</a>.<a href="#section-4.3-3" class="pilcrow">¶</a></p>
<div id="constructing-the-reportauth-extension">
<section id="section-4.3.1">
          <h4 id="name-constructing-the-reportauth">
<a href="#section-4.3.1" class="section-number selfRef">4.3.1. </a><a href="#name-constructing-the-reportauth" class="section-name selfRef">Constructing the ReportAuth extension</a>
          </h4>
<p id="section-4.3.1-1">At the time of upload, the Client selects tokens for each of the
Aggregators. The Client <span class="bcp14">MUST NOT</span> reuse a token previously used for the
same task. However, the client <span class="bcp14">MAY</span> re-use tokens for a different task.
If the client has no unused token left or the client has not obtained
tokens for a participating Aggregator, it <span class="bcp14">MUST</span> abort the upload.<a href="#section-4.3.1-1" class="pilcrow">¶</a></p>
<p id="section-4.3.1-2">The client uses the allocated token, and the token's
challenge, to construct the ReportAuth extension and include it
in the PlaintextInputShare, as specified in <span>[<a href="#DAP" class="cite xref">DAP</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04#section-4.3.2" class="relref">Section 4.3.2</a></span>. The
process is repeated for each Aggregator's input share.<a href="#section-4.3.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="setting-report-id">
<section id="section-4.3.2">
          <h4 id="name-setting-the-report-id">
<a href="#section-4.3.2" class="section-number selfRef">4.3.2. </a><a href="#name-setting-the-report-id" class="section-name selfRef">Setting the report ID</a>
          </h4>
<p id="section-4.3.2-1">As per <span>[<a href="#PPAUTHSCHEME" class="cite xref">PPAUTHSCHEME</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-auth-scheme-11#section-2.2" class="relref">Section 2.2</a></span>, the token nonce is a
randomly-generated 32-byte value. The client <span class="bcp14">MUST</span> re-use the lower 16
bytes of the nonce of the token embedded in the ReportAuth extension as
the <span>[<a href="#DAP" class="cite xref">DAP</a>]</span> report's ID. This allows Aggregators to make sure each
token is only used once per task, by leveraging the anti-reply mechanism
specified in Section <a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04#section-4.3.2" class="relref">4.3.2</a> and Section <a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04#section-4.4.1.4" class="relref">4.4.1.4</a> of <span>[<a href="#DAP" class="cite xref">DAP</a>]</span> step 6.<a href="#section-4.3.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="aggregator-behavior">
<section id="section-5">
      <h2 id="name-aggregator-behavior">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-aggregator-behavior" class="section-name selfRef">Aggregator behavior</a>
      </h2>
<p id="section-5-1">Aggregators that opt-in to support this extension and are configured to
enforce it for a given task, <span class="bcp14">MUST</span> reject reports not containing the
extension. Equally, if they do not recognize or support the extension,
they <span class="bcp14">MUST</span> reject reports containing the extension.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">In case the Aggregator is configured to support it, an additional step
is added to the Input Share Preparation in <span>[<a href="#DAP" class="cite xref">DAP</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04#section-4.4.1.5" class="relref">Section 4.4.1.5</a></span>.
Specifically, both the Leader and Helpers <span class="bcp14">MUST</span> perform the following:<a href="#section-5-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5-3.1">Extract the token and the challenge from the upload extension within
their respective ReportShare.<a href="#section-5-3.1" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-3.2">Validate the origin_info field of the challenge contains the
aggregator's hostname.<a href="#section-5-3.2" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-3.3">Validate the token, as per <span>[<a href="#PPISSUANCE" class="cite xref">PPISSUANCE</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-protocol-11#section-6.4" class="relref">Section 6.4</a></span>. This includes
verifying the token is issued with an active Issuer Token Key.<a href="#section-5-3.3" class="pilcrow">¶</a>
</li>
        <li class="normal" id="section-5-3.4">Validate <code>token.nonce[16...31] == report.metadata.report_id</code>. See
<a href="#setting-report-id" class="auto internal xref">Section 4.3.2</a>.<a href="#section-5-3.4" class="pilcrow">¶</a>
</li>
      </ul>
<p id="section-5-4">If any of the above steps fails, the aggregator <span class="bcp14">MUST</span> reject the report
share with an "unauthenticatedReport" error. Note that the binding of
report and token nonce is an optimisation, allowing aggregators to only
keep track of one set of nonces. Aggregators <span class="bcp14">MAY</span> choose to additionally
verify and keep track of the full token nonce.<a href="#section-5-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="security-considerations">
<section id="section-6">
      <h2 id="name-security-considerations">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-security-considerations" class="section-name selfRef">Security Considerations</a>
      </h2>
<div id="threat-model">
<section id="section-6.1">
        <h3 id="name-threat-model">
<a href="#section-6.1" class="section-number selfRef">6.1. </a><a href="#name-threat-model" class="section-name selfRef">Threat model</a>
        </h3>
<p id="section-6.1-1"><span>[<a href="#PPARCH" class="cite xref">PPARCH</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-architecture-13#section-4" class="relref">Section 4</a></span> defines different deployment models in which
Attester, Issuer, and Origin can be run by the same or by different
parties. The threat model for this extension assumes that at least
Attester and Issuer are run by different parties to avoid
de-anonymization attacks in which unique Issuer Token Keys could be used
to sign tokens for a targeted client. However, this threat model assumes
that the Attester and a subset of Aggregators, and Issuer and a subset
of Aggregators might be run by the same entity.<a href="#section-6.1-1" class="pilcrow">¶</a></p>
<p id="section-6.1-2">No single party should be able to associate the identity of a client
with a specific uploaded report nor learn which measurement task a given
client is contributing to.<a href="#section-6.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="timing-token-issuance">
<section id="section-6.2">
        <h3 id="name-timing-and-frequency-of-tok">
<a href="#section-6.2" class="section-number selfRef">6.2. </a><a href="#name-timing-and-frequency-of-tok" class="section-name selfRef">Timing and frequency of token issuance requests</a>
        </h3>
<p id="section-6.2-1">As discussed in <a href="#token-acquisition" class="auto internal xref">Section 4.2</a> token issuance <span class="bcp14">MUST</span> be independent
of token redemption. If clients requested tokens only in response to
receiving instructions to contribute to a measurement task, an Attester
would be able to infer which task a given client has contributed to
based on the timing of the token issuance request.<a href="#section-6.2-1" class="pilcrow">¶</a></p>
<p id="section-6.2-2">Equally, the frequency and number of token issuance requests <span class="bcp14">MUST</span> be
independent of token redemption and the timing of instructions for task
contributions. Clients <span class="bcp14">MUST</span> request tokens with a fixed frequency, e.g.
a fixed number of tokens each day. This is to prevent an Attester from
inferring which task a client has contributed to based on the number of
token issuance requests.<a href="#section-6.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="challenge-synthesis-1">
<section id="section-6.3">
        <h3 id="name-challenge-synthesis-2">
<a href="#section-6.3" class="section-number selfRef">6.3. </a><a href="#name-challenge-synthesis-2" class="section-name selfRef">Challenge synthesis</a>
        </h3>
<p id="section-6.3-1">It is assumed that challenges are synthesized by the client with an
empty redemption_context. However, adopters <span class="bcp14">MAY</span> require clients to
obtain challenges from Aggregators directly. In this case, the timing
and frequency considerations above equally apply to challenge requests.
Furthermore, clients <span class="bcp14">MUST</span> ensure that they don't reveal their identity
to the Aggregators e.g. by making challenge requests via an Oblivious
HTTP <span>[<a href="#OHTTP" class="cite xref">OHTTP</a>]</span> proxy. Otherwise, a
malicious Aggregator might issue a challenge with a unique
redemption_context that would allow it to associate upload reports with
client identities at token redemption time.<a href="#section-6.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="issuer-key-rotation">
<section id="section-6.4">
        <h3 id="name-token-key-and-issuer-origin">
<a href="#section-6.4" class="section-number selfRef">6.4. </a><a href="#name-token-key-and-issuer-origin" class="section-name selfRef">Token Key and Issuer Origin Secret rotation with rate-limited tokens</a>
        </h3>
<p id="section-6.4-1">In case the <span>[<a href="#RATE-LIMITED" class="cite xref">RATE-LIMITED</a>]</span> issuance protocol is used, Issuers <span class="bcp14">MUST</span>
periodically rotate the per-Origin Token Key and Issuer Origin Secret
values as described in <span>[<a href="#RATE-LIMITED" class="cite xref">RATE-LIMITED</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-rate-limit-tokens-01#section-10.1" class="relref">Section 10.1</a></span> to prevent
malicious clients from hoarding tokens across Issuer policy windows in
order to bypass rate limiting. While Aggregators must accommodate for
this key rotation and <span class="bcp14">SHOULD</span> accept tokens signed with the private key
associated with Token Keys older than the most recent key, they <span class="bcp14">SHOULD</span>
limit the time window during which such tokens are accepted.<a href="#section-6.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="compromised-parties-and-collusion">
<section id="section-6.5">
        <h3 id="name-compromised-parties-and-col">
<a href="#section-6.5" class="section-number selfRef">6.5. </a><a href="#name-compromised-parties-and-col" class="section-name selfRef">Compromised parties and collusion</a>
        </h3>
<p id="section-6.5-1">This section discusses the implications of compromise of the parties
involved in the protocol as well as collusion between them. Note that
these considerations differ significantly depending on whether
authenticated clients are assumed to be trusted or not. In the case
authenticated clients are assumed to potentially act maliciously, it is
assumed a rate-limiting issuance protocol as described in
<span>[<a href="#RATE-LIMITED" class="cite xref">RATE-LIMITED</a>]</span> is used.<a href="#section-6.5-1" class="pilcrow">¶</a></p>
<div id="malicious-client">
<section id="section-6.5.1">
          <h4 id="name-malicious-client">
<a href="#section-6.5.1" class="section-number selfRef">6.5.1. </a><a href="#name-malicious-client" class="section-name selfRef">Malicious Client</a>
          </h4>
<p id="section-6.5.1-1">A malicious Client may attempt to generate and upload a large number of
reports to skew aggregation results in order to reveal information about
honest measurements (privacy violation), or to influence results to
their benefit ("stats poisoning"). However, as Aggregators reject input
shares without authentication tokens, with tokens that have already been
redeemed for the same task, or with tokens that are otherwise invalid,
Clients are limited to a number of reports within the rate limit
configured at the Issuer. The rate limit should be configured so that
it is impossible to skew aggregation results by individual Clients or a
small number of colluding Clients.<a href="#section-6.5.1-1" class="pilcrow">¶</a></p>
<p id="section-6.5.1-2">A malicious Client may attempt to hoard tokens across policy windows to
bypass the rate limit. This is mitigated by the periodic Token Key and
Issuer Origin Secret rotation discussed in <a href="#issuer-key-rotation" class="auto internal xref">Section 6.4</a>.<a href="#section-6.5.1-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="malicious-attester">
<section id="section-6.5.2">
          <h4 id="name-malicious-attester">
<a href="#section-6.5.2" class="section-number selfRef">6.5.2. </a><a href="#name-malicious-attester" class="section-name selfRef">Malicious Attester</a>
          </h4>
<p id="section-6.5.2-1">A malicious Attester can choose not to authenticate clients or enforce
rate limits and allow (selected) malicious Clients to contribute an
arbitrary number of reports to one or more collections. This could lead
to stats poisoning (within the limits enforced by the VDAF). However, a
malicious Attester alone is not able to learn which task a given client
is contributing to.<a href="#section-6.5.2-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="malicious-issuer">
<section id="section-6.5.3">
          <h4 id="name-malicious-issuer">
<a href="#section-6.5.3" class="section-number selfRef">6.5.3. </a><a href="#name-malicious-issuer" class="section-name selfRef">Malicious Issuer</a>
          </h4>
<p id="section-6.5.3-1">A compromised Issuer can generate an arbitrary amount of tokens. As with
a compromised Attester that doesn't enforce rate limits, this could
allow malicious clients to contribute an arbitrary number of reports to
one or more collections to achieve stats poisoning. The Issuer never
learns the identities of clients.<a href="#section-6.5.3-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="malicious-aggregator">
<section id="section-6.5.4">
          <h4 id="name-malicious-aggregator">
<a href="#section-6.5.4" class="section-number selfRef">6.5.4. </a><a href="#name-malicious-aggregator" class="section-name selfRef">Malicious Aggregator</a>
          </h4>
<p id="section-6.5.4-1">A malicious Aggregator, e.g. Leader, could decide not to authenticate by
validating the ReportAuth token in upload reports. However, the
corresponding upload shares of the other Aggregators sent by a malicious
colluding client would fail validation. A malicious Leader could decide
to inject additional reports but Helper shares would fail validation
without valid rate-limited tokens.<a href="#section-6.5.4-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="collusion-between-attester-and-leader">
<section id="section-6.5.5">
          <h4 id="name-collusion-between-attester-">
<a href="#section-6.5.5" class="section-number selfRef">6.5.5. </a><a href="#name-collusion-between-attester-" class="section-name selfRef">Collusion between Attester and Leader</a>
          </h4>
<p id="section-6.5.5-1">It is important to prevent the Leader from identifying individual
clients to avoid de-anonymization attacks in which the Leader isolates
an upload report from a victim and injects reports with zero'd vectors.
The Helper is meant to prevent such malicious Leader injections by
validating the token included in the Helper share. However, since the
Leader and Attester collude, it is possible for the Leader to obtain an
arbitrary number of valid Helper tokens to mount such an attack.<a href="#section-6.5.5-1" class="pilcrow">¶</a></p>
<p id="section-6.5.5-2">There are two mitigations to prevent the Leader from identifying
upload reports from a specific client:<a href="#section-6.5.5-2" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-6.5.5-3.1">Clients communicate with the Leader in a privacy-preserving fashion,
e.g. via Oblivious HTTP <span>[<a href="#OHTTP" class="cite xref">OHTTP</a>]</span>, so the Leader cannot identify the
origin of a report itself<a href="#section-6.5.5-3.1" class="pilcrow">¶</a>
</li>
            <li class="normal" id="section-6.5.5-3.2">Tokens issued by the Issuer to a specific client are encrypted in the
TokenResponse (see <span>[<a href="#DAP" class="cite xref">DAP</a>], <a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04#section-6" class="relref">Section 6</a></span>) so that the Attester and a
colluding Leader cannot correlate client identities with tokens.<a href="#section-6.5.5-3.2" class="pilcrow">¶</a>
</li>
          </ul>
</section>
</div>
<div id="collusion-between-issuer-and-helper">
<section id="section-6.5.6">
          <h4 id="name-collusion-between-issuer-an">
<a href="#section-6.5.6" class="section-number selfRef">6.5.6. </a><a href="#name-collusion-between-issuer-an" class="section-name selfRef">Collusion between Issuer and Helper</a>
          </h4>
<p id="section-6.5.6-1">Issuer and Helper might be run by the same party or decide to collude.
Neither Issuer nor Helper know the identity of clients that tokens are
issued or redeemed for so that targeted attacks aren't possible by
either or both of them. The risks should be equivalent to those of a
compromised Issuer.<a href="#section-6.5.6-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
</section>
</div>
<div id="iana-considerations">
<section id="section-7">
      <h2 id="name-iana-considerations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-iana-considerations" class="section-name selfRef">IANA Considerations</a>
      </h2>
<ul class="normal ulEmpty">
<li class="normal ulEmpty" id="section-7-1.1">
          <p id="section-7-1.1.1">TODO: Assign extension type identifier<a href="#section-7-1.1.1" class="pilcrow">¶</a></p>
</li>
      </ul>
</section>
</div>
<section id="section-8">
      <h2 id="name-normative-references">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-normative-references" class="section-name selfRef">Normative References</a>
      </h2>
<dl class="references">
<dt id="DAP">[DAP]</dt>
      <dd>
<span class="refAuthor">Geoghegan, T.</span>, <span class="refAuthor">Patton, C.</span>, <span class="refAuthor">Rescorla, E.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Distributed Aggregation Protocol for Privacy Preserving Measurement"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-ppm-dap-04</span>, <time datetime="2023-03-13" class="refDate">13 March 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04">https://datatracker.ietf.org/doc/html/draft-ietf-ppm-dap-04</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="OHTTP">[OHTTP]</dt>
      <dd>
<span class="refAuthor">Thomson, M.</span> and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Oblivious HTTP"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-ohai-ohttp-08</span>, <time datetime="2023-03-15" class="refDate">15 March 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-ohai-ohttp-08">https://datatracker.ietf.org/doc/html/draft-ietf-ohai-ohttp-08</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PPARCH">[PPARCH]</dt>
      <dd>
<span class="refAuthor">Davidson, A.</span>, <span class="refAuthor">Iyengar, J.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"The Privacy Pass Architecture"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-privacypass-architecture-13</span>, <time datetime="2023-06-15" class="refDate">15 June 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-architecture-13">https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-architecture-13</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PPAUTHSCHEME">[PPAUTHSCHEME]</dt>
      <dd>
<span class="refAuthor">Pauly, T.</span>, <span class="refAuthor">Valdez, S.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"The Privacy Pass HTTP Authentication Scheme"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-privacypass-auth-scheme-11</span>, <time datetime="2023-06-23" class="refDate">23 June 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-auth-scheme-11">https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-auth-scheme-11</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="PPISSUANCE">[PPISSUANCE]</dt>
      <dd>
<span class="refAuthor">Celi, S.</span>, <span class="refAuthor">Davidson, A.</span>, <span class="refAuthor">Valdez, S.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Privacy Pass Issuance Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-privacypass-protocol-11</span>, <time datetime="2023-06-26" class="refDate">26 June 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-protocol-11">https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-protocol-11</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RATE-LIMITED">[RATE-LIMITED]</dt>
      <dd>
<span class="refAuthor">Hendrickson, S.</span>, <span class="refAuthor">Iyengar, J.</span>, <span class="refAuthor">Pauly, T.</span>, <span class="refAuthor">Valdez, S.</span>, and <span class="refAuthor">C. A. Wood</span>, <span class="refTitle">"Rate-Limited Token Issuance Protocol"</span>, <span class="refContent">Work in Progress</span>, <span class="seriesInfo">Internet-Draft, draft-ietf-privacypass-rate-limit-tokens-01</span>, <time datetime="2023-03-03" class="refDate">3 March 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-rate-limit-tokens-01">https://datatracker.ietf.org/doc/html/draft-ietf-privacypass-rate-limit-tokens-01</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC2119">[RFC2119]</dt>
      <dd>
<span class="refAuthor">Bradner, S.</span>, <span class="refTitle">"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 2119</span>, <span class="seriesInfo">DOI 10.17487/RFC2119</span>, <time datetime="1997-03" class="refDate">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>&gt;</span>. </dd>
<dd class="break"></dd>
<dt id="RFC8174">[RFC8174]</dt>
    <dd>
<span class="refAuthor">Leiba, B.</span>, <span class="refTitle">"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span class="seriesInfo">BCP 14</span>, <span class="seriesInfo">RFC 8174</span>, <span class="seriesInfo">DOI 10.17487/RFC8174</span>, <time datetime="2017-05" class="refDate">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>&gt;</span>. </dd>
<dd class="break"></dd>
</dl>
</section>
<div id="contributors">
<section id="appendix-A">
      <h2 id="name-contributors">
<a href="#name-contributors" class="section-name selfRef">Contributors</a>
      </h2>
<p id="appendix-A-1">Christopher Patton
Cloudflare
cpatton@cloudflare.com<a href="#appendix-A-1" class="pilcrow">¶</a></p>
<p id="appendix-A-2">Tommy Pauly
Apple Inc.
tpauly@apple.com<a href="#appendix-A-2" class="pilcrow">¶</a></p>
<p id="appendix-A-3">Kunal Talwar
Apple Inc.
ktalwar@apple.com<a href="#appendix-A-3" class="pilcrow">¶</a></p>
<p id="appendix-A-4">Shan Wang
Apple Inc.
shan_wang@apple.com<a href="#appendix-A-4" class="pilcrow">¶</a></p>
<p id="appendix-A-5">Christopher A. Wood
Cloudflare
caw@heapingbits.net<a href="#appendix-A-5" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-B">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Christian Priebe</span></div>
<div dir="auto" class="left"><span class="org">Apple Inc.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:cpriebe@apple.com" class="email">cpriebe@apple.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Linmao Song</span></div>
<div dir="auto" class="left"><span class="org">Apple Inc.</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:linmao_song@apple.com" class="email">linmao_song@apple.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
